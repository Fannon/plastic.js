/*! plastic - v0.0.4 - 2014-05-03
* https://github.com/Fannon/plasticjs
* Copyright (c) 2014 Simon Heimler; Licensed MIT */
var plastic={version:"0.0.4",elements:[],modules:{query:{},api:{},data:{},display:{}}};plastic.execute=function(){"use strict";console.info("plastic.js version v"+plastic.version),plastic.elements=$("plastic, .plastic-js"),plastic.elements.each(function(){var a=$(this);plastic.elements.push(new plastic.Element(a));try{}catch(b){console.error("plastic.js Element Crash")}})},$(document).ready(function(){plastic.execute()}),function(a,b,c){function d(a){return!a||"loaded"==a||"complete"==a||"uninitialized"==a}function e(a,c,e,f,h,i){var j,k,m=b.createElement("script");f=f||l.errorTimeout,m.src=a;for(k in e)m.setAttribute(k,e[k]);c=i?g:c||s,m.onreadystatechange=m.onload=function(){!j&&d(m.readyState)&&(j=1,c(),m.onload=m.onreadystatechange=null)},n(function(){j||(j=1,c(1))},f),h?m.onload():o.parentNode.insertBefore(m,o)}function f(a,c,d,e,f,h){var i,j=b.createElement("link");e=e||l.errorTimeout,c=h?g:c||s,j.href=a,j.rel="stylesheet",j.type="text/css";for(i in d)j.setAttribute(i,d[i]);f||(o.parentNode.insertBefore(j,o),n(c,0))}function g(){var a=q.shift();r=1,a?a.t?n(function(){("c"==a.t?l.injectCss:l.injectJs)(a.s,0,a.a,a.x,a.e,1)},0):(a(),g()):r=0}function h(a,c,e,f,h,i,j){function k(b){if(!p&&d(m.readyState)&&(t.r=p=1,!r&&g(),m.onload=m.onreadystatechange=null,b)){"img"!=a&&n(function(){v.removeChild(m)},50);for(var e in F[c])F[c].hasOwnProperty(e)&&F[c][e].onload()}}j=j||l.errorTimeout;var m=b.createElement(a),p=0,s=0,t={t:e,s:c,e:h,a:i,x:j};1===F[c]&&(s=1,F[c]=[]),"object"==a?m.data=c:(m.src=c,m.type=a),m.width=m.height="0",m.onerror=m.onload=m.onreadystatechange=function(){k.call(this,s)},q.splice(f,0,t),"img"!=a&&(s||2===F[c]?(v.insertBefore(m,u?null:o),n(k,j)):F[c].push(m))}function i(a,b,c,d,e){return r=0,b=b||"j",C(a)?h("c"==b?z:y,a,b,this.i++,c,d,e):(q.splice(this.i++,0,a),1==q.length&&g()),this}function j(){var a=l;return a.loader={load:i,i:0},a}var k,l,m=b.documentElement,n=a.setTimeout,o=b.getElementsByTagName("script")[0],p={}.toString,q=[],r=0,s=function(){},t="MozAppearance"in m.style,u=t&&!!b.createRange().compareNode,v=u?m:o.parentNode,w=a.opera&&"[object Opera]"==p.call(a.opera),x=!!b.attachEvent&&!w,y=t?"object":x?"script":"img",z=x?"script":y,A=Array.isArray||function(a){return"[object Array]"==p.call(a)},B=function(a){return Object(a)===a},C=function(a){return"string"==typeof a},D=function(a){return"[object Function]"==p.call(a)},E=[],F={},G={timeout:function(a,b){return b.length&&(a.timeout=b[0]),a}};l=function(a){function b(a){var b,c,d,e=a.split("!"),f=E.length,g=e.pop(),h=e.length,i={url:g,origUrl:g,prefixes:e};for(c=0;h>c;c++)d=e[c].split("="),b=G[d.shift()],b&&(i=b(i,d));for(c=0;f>c;c++)i=E[c](i);return i}function d(a){return a.split(".").pop().split("?").shift()}function e(a,e,f,g,h){{var i=b(a),k=i.autoCallback;d(i.url)}if(!i.bypass)return e&&(e=D(e)?e:e[a]||e[g]||e[a.split("/").pop().split("?")[0]]),i.instead?i.instead(a,e,f,g,h):(F[i.url]?i.noexec=!0:F[i.url]=1,f.load(i.url,i.forceCSS||!i.forceJS&&"css"==d(i.url)?"c":c,i.noexec,i.attrs,i.timeout),(D(e)||D(k))&&f.load(function(){j(),e&&e(i.origUrl,h,g),k&&k(i.origUrl,h,g),F[i.url]=2}),void 0)}function f(a,b){function c(a,c){if(a){if(C(a))c||(j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}),e(a,j,b,0,g);else if(B(a)){d=function(){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c}();for(f in a)a.hasOwnProperty(f)&&(c||--d||(D(j)?j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}:j[f]=function(a){return function(){var b=[].slice.call(arguments);a&&a.apply(this,b),l()}}(k[f])),e(a[f],j,b,f,g))}}else!c&&l()}var d,f,g=!!a.test,h=g?a.yep:a.nope,i=a.load||a.both,j=a.callback||s,k=j,l=a.complete||s;c(h,!!i),i&&c(i)}var g,h,i=this.yepnope.loader;if(C(a))e(a,0,i,0);else if(A(a))for(g=0;g<a.length;g++)h=a[g],C(h)?e(h,0,i,0):A(h)?l(h):B(h)&&f(h,i);else B(a)&&f(a,i)},l.addPrefix=function(a,b){G[a]=b},l.addFilter=function(a){E.push(a)},l.errorTimeout=1e4,null==b.readyState&&b.addEventListener&&(b.readyState="loading",b.addEventListener("DOMContentLoaded",k=function(){b.removeEventListener("DOMContentLoaded",k,0),b.readyState="complete"},0)),a.yepnope=j(),a.yepnope.executeStack=g,a.yepnope.injectJs=e,a.yepnope.injectCss=f}(this,document),plastic.options={debug:!0,width:"100%"},plastic.Element=function(a){this.el=a,this.attributes=new plastic.ElementAttributes(a),this.attr=this.attributes.attr,this.queryModule=!1,this.dataModule=!1,this.displayModule=!1,this.process(this.el,this.attr)},plastic.Element.prototype={getEl:function(){return this.el},setEl:function(a){this.el=a},getAttr:function(){return this.attr},process:function(a,b){console.info("plastic.processElement();");var c,d=!1,e=!1,f=this;if(this.createMsgContainer(a),this.createDisplayContainer(a),b.query&&(b=this.callQueryParser(a,b)),b.data&&b.data.url){var g=(new Date).getTime();d=!0,console.log("Getting Data from URL via AJAX: "+b.data.url),c=$.getJSON(b.data.url).done(function(c){try{b.data.raw=null!==c&&"object"==typeof c?c:$.parseJSON(c)}catch(d){plastic.msg(d,"error",a)}}).fail(function(){plastic.msg('Could not get Data from URL <a href="'+b.data.url+'">'+b.data.url+"</a>","error",a),e=!0}).always(function(){var a=(new Date).getTime()-g;console.log("Request completed in "+a+"ms")})}d?c.complete(function(){console.log("Received asynchronous data."),e||f.callDataParser(a,b),e||f.callDisplayModule(a,b)}):(console.log("Received Synchronous Data"),e||f.callDataParser(a,b),e||f.callDisplayModule(a,b))},createMsgContainer:function(a){"use strict";a.css("position","relative"),a.append('<div class="plastic-js-msg"></div>');var b=a.find(".plastic-js-msg");b.height(a.height()).width(a.width())},createDisplayContainer:function(a){"use strict";console.info("plastic.prepareCanvas();"),a.append('<div class="plastic-js-display"></div>');var b=a.find(".plastic-js-display");b.height(a.height()).width(a.width())},callQueryParser:function(a,b){console.info("processElement.callQueryParser(); "+b.query.type);var c=plastic.modules.registry.get("query",[b.query.type]),d=plastic.modules.query[c.className];return d?(console.log("Using Parser: "+c.className),this.queryModule=new d(b.query),this.validateModule(this.queryModule,b.query),b.data=this.queryModule.parse()):plastic.msg("Query Parser Module "+b.query.type+" not found.","error",a),b},callDataParser:function(a,b){console.info("processElement.callDataParser()");var c=plastic.modules.registry.get("data",[b.data.parser]),d=plastic.modules.data[c.className];d?(console.log("Using Parser: "+c.className),console.dir(b),this.dataModule=new d(b.data),this.validateModule(this.dataModule,b.data.raw),b.data=this.dataModule.parse()):plastic.msg("Data Parser Module "+b.data.parser+" not found.","error",a)},callDisplayModule:function(a,b){console.info("plastic.Element.callDisplayModule()");var c=plastic.modules.registry.get("display",[b.options.display.module]),d=plastic.modules.display[c.className];d?(console.log("Using Display Module: "+c.className),this.displayModule=new d(a,b),this.validateModule(this.displayModule,b.options.display),this.displayModule.render()):plastic.msg("Display Module "+b.data.parser+" not found.","error",a)},validateModule:function(a,b){if(a.validate){var c=a.validate();if(c)throw console.dir(c),new Error("Validation Error!")}if(a.validationSchema){console.log("Schema Validation");var d=jjv();d.addSchema("data",a.validationSchema);var e=d.validate("data",b);if(e)throw console.dir(e),new Error("Data Structure invalid!")}}},plastic.ElementAttributes=function(a){this.el=a,this.attr=this.parseAttr(a),this.validate(this.attr)},plastic.ElementAttributes.prototype={getAttr:function(){"use strict";return this.attr},parseAttr:function(a){"use strict";console.info("plastic.getElementAttributes();");var b={};b.style=this.getStyle(a),b.options=this.getOptions(a);var c=this.getQuery(a);c&&(b.query=c);var d=this.getSchema(a);d&&(b.schema=d);var e=this.getData(a);return e&&(b.data=e),console.log(b),b},getStyle:function(a){"use strict";var b={};return b.height=a.height(),b.width=a.width(),b},getOptions:function(a){"use strict";var b={},c=a.find(".plastic-options");if(!(c.length>0))return plastic.msg("No options provided!","error",a),!1;var d=c[0].text;if(!d||""===d)return plastic.msg("Empty Obptions Element!","error",a),!1;try{return b=$.parseJSON(d)}catch(e){return plastic.msg("Invalid JSON in the Options Object!"),!1}},getQuery:function(a){"use strict";var b=a.find(".plastic-query");if(b.length>0){var c={};c.url=b.attr("data-query-url"),c.type=b.attr("type");var d=b[0].text;return d&&""!==d?(c.text=d,c):(plastic.msg("Empty Query Element!","error",a),!1)}},getSchema:function(a){"use strict";var b=a.find(".plastic-schema");if(b.length>0){var c={};c.type=b.attr("data-schema-format");var d=b[0].text;return d&&""!==d?(c.text=$.parseJSON(d),c):(plastic.msg("Empty Schema Element!","error",a),!1)}},getData:function(a){"use strict";var b={},c=a.find(".plastic-data");if(c.length>0){if(b.url=c.attr("data-url"),b.parser=c.attr("data-format"),!b.url){var d=c[0].text;d&&""!==d?b.raw=$.parseJSON(d):plastic.msg("Empty Data Element!","error",a)}return b}return!1},validate:function(a){"use strict";var b={$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{style:{type:"object",properties:{width:{type:"number"},height:{type:"number"}}},options:{type:"object",properties:{general:{type:"object"},display:{type:"object",properties:{module:{type:"string"},options:{type:"object"}},required:["module","options"]}},required:["general","display"]},query:{type:"object",properties:{text:{type:"string"},type:{type:"string"},url:{type:"string"}},required:["text","type","url"]},schema:{type:"object",properties:{text:{type:"string"}},required:["text"]},data:{type:"object",properties:{parser:{type:"string"},raw:{type:["object","array","string"]},processed:{type:"array"},url:{type:"string"}},required:["parser"]}},required:["style","options"]},c=jjv();c.addSchema("schema",b);var d=c.validate("schema",a);if(d)throw console.dir(d),new Error("Data Structure invalid!");return!0}},plastic.msg=function(){var a=function(a,c,d){c?"error"===c?null!==a&&"object"==typeof a?(console.error(a),b(a,c,d)):(console.error(c+" :: "+a),b(a,c,d)):"warning"===c?console.warn(c+" :: "+a):"info"===c?console.info(c+" :: "+a):console.log(c+" :: "+a):console.log("--> "+a)},b=function(a,b,c){c.find(".plastic-js-msg").append('<div class="plastic-msg plastic-msg-error"><strong>'+b.toUpperCase()+":</strong> "+a+"</div>")};return a}();